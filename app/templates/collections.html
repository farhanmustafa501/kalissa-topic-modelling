{% extends "base.html" %}
{% block title %}Collections{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
	<div>
		<h2 class="h4 mb-0">Collections</h2>
		<div class="text-muted small">Create a collection, add documents, and explore its topic graph.</div>
	</div>
	<div>
		<button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newCollectionModal">New Collection</button>
	</div>
	<div class="modal fade" id="newCollectionModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Create Collection</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form 
						hx-post="/api/collections" 
						hx-swap="none" 
						hx-trigger="submit"
						hx-indicator="#create-loading"
						onsubmit="event.preventDefault(); return true;"
						hx-on::afterRequest="handleCollectionCreate(event)">
						<div class="mb-2">
							<label class="form-label">Name</label>
							<input class="form-control" name="name" required />
						</div>
						<div class="mb-2">
							<label class="form-label">Description</label>
							<textarea class="form-control" name="description" rows="2"></textarea>
						</div>
						<div class="d-flex align-items-center gap-2">
							<button class="btn btn-primary" type="submit">Create</button>
							<div id="create-loading" class="spinner-border spinner-border-sm htmx-indicator" role="status"></div>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</div>
{% if collections %}
<div class="row row-cols-1 row-cols-md-3 g-3">
	{% for c in collections %}
	<div class="col">
		<div class="card h-100 position-relative">
			<div class="card-body">
				<div class="d-flex justify-content-between align-items-start">
					<a href="/collections/{{ c.id }}" class="text-decoration-none text-reset flex-grow-1">
						<div>
							<h5 class="card-title mb-1">{{ c.name }}</h5>
							<div class="text-muted small mb-2">{{ c.description or 'No description' }}</div>
						</div>
					</a>
					<button class="btn btn-sm btn-outline-danger ms-2" type="button"
						hx-delete="/api/collections/{{ c.id }}" 
						hx-confirm="Delete this collection?" 
						hx-target="closest .col" 
						hx-swap="outerHTML:remove"
						onclick="event.stopPropagation();">
						Delete
					</button>
				</div>
			</div>
		</div>
	</div>
	{% endfor %}
	</div>
{% else %}
<div class="alert alert-info">No collections yet. Click "New Collection" to get started.</div>
{% endif %}
<script>
function handleCollectionCreate(event) {
	try {
		const xhr = event.detail.xhr;
		if (xhr.status === 201 || xhr.status === 200) {
			const responseText = xhr.responseText || '';
			let data = {};
			try {
				data = JSON.parse(responseText);
			} catch (e) {
				console.error('Failed to parse response:', e);
			}
			
			// Close modal
			const modal = bootstrap.Modal.getInstance(document.getElementById('newCollectionModal'));
			if (modal) {
				modal.hide();
			}
			
			// Reset form
			const form = document.querySelector('#newCollectionModal form');
			if (form) {
				form.reset();
			}
			
			// Redirect to collection detail or refresh
			if (data && data.id) {
				window.location.href = '/collections/' + data.id;
			} else {
				window.location.reload();
			}
		} else {
			// Show error
			const responseText = xhr.responseText || 'Failed to create collection';
			let errorMsg = 'Failed to create collection';
			try {
				const errorData = JSON.parse(responseText);
				errorMsg = errorData.error || errorMsg;
			} catch (e) {
				errorMsg = responseText;
			}
			alert(errorMsg);
		}
	} catch (err) {
		console.error('Error handling collection creation:', err);
		alert('An error occurred while creating the collection');
	}
}
</script>
{% endblock %}



