<div class="topic-detail-container">
	<!-- Topic Header -->
	<div class="d-flex justify-content-between align-items-start mb-4 pb-3 border-bottom">
		<div class="flex-grow-1">
			<h4 class="mb-2">{{ topic.name }}</h4>
			{% if insight and insight.summary %}
			<p class="text-muted mb-0">{{ insight.summary }}</p>
			{% else %}
			<p class="text-muted mb-0">No summary available for this topic.</p>
			{% endif %}
		</div>
		<div class="ms-3">
			<span class="badge bg-primary fs-6">{{ topic.document_count }} document{{ 's' if topic.document_count != 1 else '' }}</span>
		</div>
	</div>

	<div class="row g-4">
		<!-- Left Column: Insights -->
		<div class="col-lg-6">
			<!-- Key Themes -->
			{% if insight and insight.key_themes %}
			<div class="mb-4">
				<h6 class="mb-3 d-flex align-items-center">
					<span class="me-2">üéØ</span>
					Key Themes
				</h6>
				<div class="d-flex flex-wrap gap-2">
					{% for theme in insight.key_themes %}
					<span class="badge bg-light text-dark border px-3 py-2">{{ theme }}</span>
					{% endfor %}
				</div>
			</div>
			{% endif %}

			<!-- Common Questions -->
			{% if insight and insight.common_questions %}
			<div class="mb-4">
				<h6 class="mb-3 d-flex align-items-center">
					<span class="me-2">‚ùì</span>
					Common Questions
				</h6>
				<ul class="list-unstyled">
					{% for question in insight.common_questions %}
					<li class="mb-2 ps-3 border-start border-3 border-info">
						<small>{{ question }}</small>
					</li>
					{% endfor %}
				</ul>
			</div>
			{% endif %}

			<!-- Related Concepts -->
			{% if insight and insight.related_concepts %}
			<div class="mb-4">
				<h6 class="mb-3 d-flex align-items-center">
					<span class="me-2">üîó</span>
					Related Concepts
				</h6>
				<div class="d-flex flex-wrap gap-2">
					{% for concept in insight.related_concepts %}
					<span class="badge bg-secondary px-3 py-2">{{ concept }}</span>
					{% endfor %}
				</div>
			</div>
			{% endif %}

			<!-- Related Topics -->
			{% if related_topics %}
			<div class="mb-4">
				<h6 class="mb-3 d-flex align-items-center">
					<span class="me-2">üåê</span>
					Related Topics
				</h6>
				<div class="list-group list-group-flush">
					{% for rt in related_topics %}
					<div class="list-group-item px-0 py-2 d-flex justify-content-between align-items-center">
						<a href="#" onclick="loadTopicById({{ rt.id }}); return false;" class="text-decoration-none flex-grow-1">
							{{ rt.name }}
						</a>
						<span class="badge bg-light text-dark">{{ "%.0f"|format(rt.similarity * 100) }}%</span>
					</div>
					{% endfor %}
				</div>
			</div>
			{% endif %}
		</div>

		<!-- Right Column: Documents -->
		<div class="col-lg-6">
			<h6 class="mb-3 d-flex align-items-center">
				<span class="me-2">üìÑ</span>
				Documents (Ranked by Relevance)
			</h6>
			{% if ranked_docs %}
			<div class="documents-list">
				{% for row in ranked_docs %}
				{% set d = row.Document %}
				{% set dt = row.DocumentTopic %}
				<div class="card mb-3 document-card" id="topic-doc-{{ d.id }}" data-doc-id="{{ d.id }}">
					<div class="card-body p-3">
						<div class="d-flex justify-content-between align-items-start mb-2">
							<h6 class="card-title mb-0 flex-grow-1 me-2">{{ d.title }}</h6>
							<div class="d-flex gap-1">
								{% if dt.is_primary %}
								<span class="badge bg-success">Primary</span>
								{% else %}
								<span class="badge bg-info">Secondary</span>
								{% endif %}
								{% if dt.relevance_score %}
								<span class="badge bg-light text-dark">{{ "%.0f"|format(dt.relevance_score * 100) }}%</span>
								{% endif %}
							</div>
						</div>
						{% if d.preview %}
						<p class="card-text small text-muted mb-0" style="line-height: 1.5;">
							{{ d.preview[:200] }}{% if d.preview|length > 200 %}...{% endif %}
						</p>
						{% else %}
						<p class="card-text small text-muted mb-0">No preview available</p>
						{% endif %}
					</div>
				</div>
				{% endfor %}
			</div>
			{% else %}
			<p class="text-muted small">No documents found for this topic.</p>
			{% endif %}
		</div>
	</div>

	<!-- Q&A Section -->
	<div class="mt-4 pt-4 border-top">
		<h6 class="mb-3 d-flex align-items-center">
			<span class="me-2">üí¨</span>
			Ask Questions About This Topic
		</h6>
		<form class="mb-3" onsubmit="submitTopicQuestion(event, {{ topic.id }}); return false;">
			<div class="input-group">
				<input type="text" class="form-control" id="question-input-{{ topic.id }}" placeholder="Ask a question about this topic..." required />
				<button type="submit" class="btn btn-primary" id="qa-submit-btn-{{ topic.id }}">
					Ask
				</button>
			</div>
		</form>
		<div id="qa-answer-{{ topic.id }}" class="qa-answer-container">
			<p class="text-muted small mb-0">Answers will appear here with inline citations. Click citations to view source documents.</p>
		</div>
	</div>
</div>

<script>
function loadTopicById(topicId) {
	const nodeId = 't' + topicId;
	if (window.networkInstance) {
		// Select the node in vis-network
		window.networkInstance.selectNodes([nodeId]);
		// Trigger click event to load details
		loadTopicDetailsByNodeId(nodeId);
		// Center on the node
		window.networkInstance.focus(nodeId, {
			scale: 1.2,
			animation: true
		});
	} else {
		htmx.ajax('GET', '/ui/topics/' + topicId, '#topic-detail-pane');
	}
}

async function submitTopicQuestion(event, topicId) {
	event.preventDefault();
	const input = document.getElementById('question-input-' + topicId);
	const answerDiv = document.getElementById('qa-answer-' + topicId);
	const submitBtn = document.getElementById('qa-submit-btn-' + topicId);
	
	const question = input.value.trim();
	if (!question) return;
	
	submitBtn.disabled = true;
	submitBtn.textContent = 'Asking...';
	answerDiv.innerHTML = '<div class="text-muted small">Generating answer...</div>';
	
	try {
		const formData = new FormData();
		formData.append('question', question);
		
		const response = await fetch('/api/topics/' + topicId + '/qa', {
			method: 'POST',
			body: formData
		});
		
		if (!response.ok) {
			throw new Error('Failed to get answer');
		}
		
		const html = await response.text();
		answerDiv.innerHTML = html;
		
		// Attach click handlers to citations
		answerDiv.querySelectorAll('.citation').forEach(citation => {
			citation.style.cursor = 'pointer';
			citation.style.color = '#4f46e5';
			citation.style.textDecoration = 'underline';
			citation.onclick = function() {
				const docId = this.getAttribute('data-doc-id');
				if (docId) {
					scrollToDocument(docId);
				}
			};
		});
		
	} catch (error) {
		answerDiv.innerHTML = '<div class="alert alert-danger small">Failed to get answer. Please try again.</div>';
		console.error('Q&A error:', error);
	} finally {
		submitBtn.disabled = false;
		submitBtn.textContent = 'Ask';
		input.value = '';
	}
}

function scrollToDocument(docId) {
	// Scroll to document in topic detail
	const docCard = document.getElementById('topic-doc-' + docId);
	if (docCard) {
		docCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
		docCard.style.backgroundColor = '#fff3cd';
		setTimeout(() => {
			docCard.style.backgroundColor = '';
		}, 2000);
	}
	
	// Also scroll to document in sidebar
	const sidebarDoc = document.getElementById('doc-' + docId);
	if (sidebarDoc) {
		sidebarDoc.scrollIntoView({ behavior: 'smooth', block: 'center' });
		sidebarDoc.style.backgroundColor = '#fff3cd';
		setTimeout(() => {
			sidebarDoc.style.backgroundColor = '';
		}, 2000);
	}
}

// Make cyInstance accessible globally
if (typeof cyInstance !== 'undefined') {
	window.cyInstance = cyInstance;
}
</script>

<style>
.topic-detail-container {
	padding: 0;
}

.document-card {
	transition: all 0.2s ease;
	border: 1px solid #e5e7eb;
}

.document-card:hover {
	box-shadow: 0 2px 8px rgba(0,0,0,0.1);
	border-color: #4f46e5;
}

.qa-answer-container {
	min-height: 50px;
	padding: 1rem;
	background: #f9fafb;
	border-radius: 0.5rem;
	border: 1px solid #e5e7eb;
}

.qa-answer-container .citation {
	color: #4f46e5;
	text-decoration: underline;
	cursor: pointer;
	font-weight: 600;
}

.qa-answer-container .citation:hover {
	color: #6366f1;
}
</style>
