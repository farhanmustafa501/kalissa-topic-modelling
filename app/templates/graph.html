{% extends "base.html" %}
{% block title %}Collection {{ collection_id }} – Graph{% endblock %}
{% block head_scripts %}
<script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
{% endblock %}
{% block content %}
<section>
	<div class="d-flex justify-content-between align-items-center mb-3">
		<div>
			<h2 class="h4 mb-0">Collection {{ collection_id }} – Topic Graph</h2>
			<div class="text-muted small">Interactive graph of topics and relationships</div>
		</div>
		<div class="d-flex align-items-center gap-2">
			<button class="btn btn-primary btn-sm" hx-post="/api/collections/{{ collection_id }}/discover" hx-target="#job-status" hx-indicator="#job-loading">Run Discovery</button>
			<div class="spinner-border spinner-border-sm htmx-indicator" id="job-loading" role="status"></div>
		</div>
	</div>
	<div class="card shadow-sm mb-3">
		<div class="card-body">
			<div class="row g-3 align-items-center">
				<div class="col-md-4">
					<div class="input-group input-group-sm">
						<span class="input-group-text">Search</span>
						<input type="text" class="form-control" placeholder="Filter topics">
					</div>
				</div>
				<div class="col-md-4">
					<label class="form-label small mb-1">Node size</label>
					<input type="range" class="form-range" min="0" max="100" value="50" />
				</div>
				<div class="col-md-4">
					<div class="d-flex align-items-center gap-3">
						<div class="legend-dot bg-primary"></div><span class="small text-muted">Topic</span>
						<div class="legend-line"></div><span class="small text-muted">Related</span>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="row g-3">
		<div class="col-lg-8">
			<div class="card">
				<div id="cy" class="graph-surface"></div>
			</div>
		</div>
		<div class="col-lg-4">
			<div class="card">
				<div class="card-header py-2">
					<ul class="nav nav-tabs card-header-tabs" role="tablist">
						<li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-details" type="button">Details</button></li>
						<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-qa" type="button">Q&A</button></li>
					</ul>
				</div>
				<div class="card-body tab-content">
					<div class="tab-pane fade show active" id="tab-details">
						<div id="topic-detail-pane"><p class="text-muted small">Select a topic node to view details.</p></div>
					</div>
					<div class="tab-pane fade" id="tab-qa">
						<p class="text-muted small">Open a topic in Details, then ask a question here.</p>
					</div>
				</div>
			</div>
			<div id="job-status" class="mt-3"></div>
			<div 
				hx-get="/ui/collections/{{ collection_id }}/discover/status"
				hx-trigger="every 3s"
				hx-target="#job-status"
				hx-swap="outerHTML">
				<!-- status will be injected here -->
			</div>
		</div>
	</div>
</section>
<script>
(async function init() {
	const res = await fetch('/api/collections/{{ collection_id }}/topics/graph');
	const data = await res.json();
	const cy = cytoscape({
		container: document.getElementById('cy'),
		elements: [
			...data.nodes.map(n => ({ data: { id: n.id, label: n.label, size: Math.max(20, Math.round(20 + (n.size_score || 0) * 30)) } })),
			...data.edges.map(e => ({ data: { id: e.source + '_' + e.target, source: e.source, target: e.target, weight: e.weight } }))
		],
		style: [
			{ selector: 'node', style: { 'label': 'data(label)', 'background-color': '#4f46e5', 'color': '#fff', 'text-valign': 'center', 'width': 'data(size)', 'height': 'data(size)', 'font-size': 10 } },
			{ selector: 'edge', style: { 'width': 2, 'line-color': '#a5b4fc', 'target-arrow-color': '#a5b4fc' } },
			{ selector: ':selected', style: { 'background-color': '#111827' } }
		],
		layout: { name: 'cose', fit: true, padding: 20 }
	});

	cy.on('tap', 'node', (evt) => {
		const id = evt.target.id();
		htmx.ajax('GET', '/ui/topics/' + id.replace('t',''), '#topic-detail-pane');
	});
})();
</script>
{% endblock %}


